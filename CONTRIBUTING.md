# Steps to release

**Note**: These steps can also be used to release a docker-cloud-action image to test your changes.

## Step 1. Log into docker ghcr.io

See [authenticate to GHCR with a PAT](https://docs.github.com/en/packages/working-with-a-github-packages-registry/working-with-the-container-registry#authenticating-to-the-container-registry).

If you have a PAT handy you can just do:

```
% echo $YOUR_GITHUB_PAT | docker login ghcr.io -u $YOUR_GITHUB_USERNAME --password-stdin
```

## Step 2. Determine the new point version and create a release branch.

```
% git checkout main
% git fetch origin --tags --force
% git tag
pex-v0.1
pex-v0.1.14
prha
v0.1
v1.10.12
```

```
% git checkout -b release-1.10.13
```

## Step 3. Build and deploy a new docker-cloud-action image, a new dagster.cloud.pex and update code references to docker

A script does this work. **Note**: a virtual environment using Python3.11 is required to run the script.

```bash
# Note no 'v' prefix
python scripts/release.py create-rc 1.10.13
```

This leaves uncommitted changes in the working directory.

# Commit and tag the new version

```bash
# View changes made by the release script
git diff

# Commit
git add . && git commit -m "Rebuild"

# Tag: using '-a' lets us add an annotation message, typically we use the version "v0.1.22"
git tag -a v1.10.13
```

# Step 5. Push and Test

```bash
# push the release branch
git push --set-upstream origin release-1.10.13
# push the tag
git push origin v1.10.13
# to test, change the reference in a github workflow yaml file `@v0.1 -> @v0.1.22` and `@pex-v0.1 -> @v1.10.13`
# see also dagster-cloud-action-test
```

It is recommended to test the release with both Serverless and Hybrid deployments.

Serverless:
- GitLab: Deploy to a test organization in Dagster+ after updating the image version in the CI/CD file.
- GitHub: Deploy to a test organization in Dagster+ with both PEX and docker deployments.

Hybrid:
- GitHub: Create a new branch in the [Hooli repo](https://github.com/dagster-io/hooli-data-eng-pipelines) to update the tags with the new version in the CI/CD file. Push your changes and open a PR to test the deployment to Dagster+.

# Step 5b. Iterate

If you make any changes and rebuild the rc, you need to retag and push the release tag:

```bash
python scripts/release.py create-rc 1.10.13

# the only autogenerated change should be to the pex file because changes to the yamls have already committed

# -f to force since the tag exists
git tag -f -a v1.10.13
git push -f origin v1.10.13

# test again, fix and repeat
```

# Development and testing

## Testing the dagster-cloud.pex against a Dagster development branch

To test against a Dagster development branch, that has been pushed against the open source repository, you can build
the `./generated/gha/dagster-cloud.pex` file locally.

```bash
python ./scripts/release.py create-rc <new tag> <old tag> \
  --dagster-oss-branch <dagster_branch> \
  --no-publish-docker-action
```